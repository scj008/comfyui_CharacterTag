import { app } from "../../scripts/app.js";

app.registerExtension({
    name: "Opentag Monitor",
    async setup() {
        console.log("âœ… æ’ä»¶å·²åŠ è½½ - ç­‰å¾…å·¥ä½œæµå‡†å¤‡å°±ç»ª");

        // é˜²æŠ–è®¡æ—¶å™¨å˜é‡
        let debounceTimer = null;

        // ä½¿ç”¨å›è°ƒå‡½æ•°ç¡®ä¿åœ¨èŠ‚ç‚¹æ·»åŠ åæ‰§è¡Œæ£€æŸ¥
        const checkNodes = () => {
            if (debounceTimer) {
                clearTimeout(debounceTimer);
                debounceTimer = null;
            }

            if (!app.graph) {
                console.error("âŒ app.graph æœªå®šä¹‰ï¼");
                return;
            }

            const nodes = app.graph.nodes || [];
            console.log(`ğŸ“‹ å½“å‰å·¥ä½œæµä¸­æœ‰ ${nodes.length} ä¸ªèŠ‚ç‚¹`);

            // æ‰©å±•èŠ‚ç‚¹ç±»å‹åŒ¹é…æ¡ä»¶
            const opentagNodes = nodes.filter(node =>
                node?.type.includes("æ‰“å¼€æç¤ºè¯æ ‡ç­¾") ||
                node?.type === "æ‰“å¼€æç¤ºè¯æ ‡ç­¾"
            );

            if (opentagNodes.length === 0) {
                console.log("âš ï¸ å·¥ä½œæµä¸­æ²¡æœ‰æ‰¾åˆ°OpentagèŠ‚ç‚¹");
                return;
            }

            // éå†æ‰€æœ‰OpentagèŠ‚ç‚¹å¹¶æ£€æŸ¥æ§ä»¶åˆ—è¡¨
            opentagNodes.forEach((node, index) => {
                console.log(`\nğŸ”§ æ£€æŸ¥èŠ‚ç‚¹ ${index + 1}/${opentagNodes.length}: ID ${node.id}`);
                console.log(`  èŠ‚ç‚¹ç±»å‹: ${node.type}`);

                // æ£€æŸ¥æ§ä»¶æ˜¯å¦å­˜åœ¨
                const inputTextWidget = node.widgets?.find(w => w.name === "input_text");
                const inputText1Widget = node.widgets?.find(w => w.name === "input_text1");
                const testReplaceWidget = node.widgets?.find(w => w.name === "æµ‹è¯•æ›¿æ¢1");

                // è¾“å‡ºç»“æœ
                console.log(inputTextWidget ? "âœ… æ‰¾åˆ° input_text æ§ä»¶" : "âŒ æœªæ‰¾åˆ° input_text æ§ä»¶");
                console.log(inputText1Widget ? "âœ… æ‰¾åˆ° input_text1 æ§ä»¶" : "âŒ æœªæ‰¾åˆ° input_text1 æ§ä»¶");
                console.log(testReplaceWidget ? "âœ… æ‰¾åˆ° æµ‹è¯•æ›¿æ¢1 æ§ä»¶" : "âŒ æœªæ‰¾åˆ° æµ‹è¯•æ›¿æ¢1 æ§ä»¶");

                // è¯¦ç»†è¾“å‡ºæ‰€æœ‰æ§ä»¶åˆ—è¡¨
                if (node.widgets?.length > 0) {
                    console.log("ğŸ“‹ èŠ‚ç‚¹æ§ä»¶åˆ—è¡¨ (å…± " + node.widgets.length + " ä¸ª):");
                    node.widgets.forEach((widget, i) => {
                        console.log(`  ${i + 1}. ${widget.name} (ç±»å‹: ${widget.type})`);

                        // è¾“å‡ºæ§ä»¶çš„å½“å‰å€¼ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                        if (widget.value !== undefined) {
                            console.log(`    å½“å‰å€¼: ${JSON.stringify(widget.value)}`);
                        }

                        // è¾“å‡ºæ§ä»¶çš„é€‰é¡¹ï¼ˆå¦‚æœæ˜¯ä¸‹æ‹‰èœå•ï¼‰
                        if (widget.options) {
                            console.log(`    é€‰é¡¹: ${JSON.stringify(widget.options)}`);
                        }
                    });
                } else {
                    console.log("âš ï¸ è¯¥èŠ‚ç‚¹æ²¡æœ‰æ§ä»¶");
                }
            });
        };

        // é˜²æŠ–ç‰ˆæœ¬çš„æ£€æŸ¥å‡½æ•°
        const debouncedCheckNodes = () => {
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(checkNodes, 300); // 300msé˜²æŠ–æ—¶é—´
        };

        // åˆå§‹æ£€æŸ¥ï¼ˆä½¿ç”¨é˜²æŠ–ï¼‰
        debouncedCheckNodes();

        // ç›‘å¬èŠ‚ç‚¹æ·»åŠ äº‹ä»¶ï¼ˆä½¿ç”¨é˜²æŠ–ï¼‰
        app.graph.onNodeAdded = function(node) {
            console.log(`â• èŠ‚ç‚¹æ·»åŠ : ${node.type}`);
            debouncedCheckNodes();
        };

        // ç›‘å¬å·¥ä½œæµå˜æ›´äº‹ä»¶ï¼ˆä½¿ç”¨é˜²æŠ–ï¼‰
        app.graph.onConfigure = function() {
            console.log("ğŸ”„ å·¥ä½œæµé…ç½®å˜æ›´");
            debouncedCheckNodes();
        };
    },
});
