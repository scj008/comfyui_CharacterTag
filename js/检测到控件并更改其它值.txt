import { app } from "../../scripts/app.js";

app.registerExtension({
    name: "Opentag Monitor",
    async setup() {
        console.log("âœ… æ’ä»¶å·²åŠ è½½ - ç­‰å¾…å·¥ä½œæµå‡†å¤‡å°±ç»ª");

        // å­˜å‚¨å·²æ³¨å†Œç›‘å¬å™¨çš„èŠ‚ç‚¹ID
        const registeredNodes = new Set();

        // ç®€åŒ–çš„èŠ‚ç‚¹æ£€æŸ¥å‡½æ•°
        const checkAndSetupNodes = () => {
            if (!app.graph || !app.graph.nodes) return;

            // æŸ¥æ‰¾æ‰€æœ‰OpentagèŠ‚ç‚¹
            const opentagNodes = app.graph.nodes.filter(node =>
                node?.type.includes("æ‰“å¼€æç¤ºè¯æ ‡ç­¾") ||
                node?.type === "æ‰“å¼€æç¤ºè¯æ ‡ç­¾"
            );

            // éå†èŠ‚ç‚¹å¹¶è®¾ç½®åŒæ­¥
            opentagNodes.forEach(node => {
                // ç¡®ä¿æ‰¾åˆ°ä¸¤ä¸ªæ§ä»¶ä¸”èŠ‚ç‚¹å°šæœªæ³¨å†Œç›‘å¬å™¨
                const inputTextWidget = node.widgets?.find(w => w.name === "input_text");
                const inputText1Widget = node.widgets?.find(w => w.name === "input_text1");

                if (inputTextWidget && inputText1Widget && !registeredNodes.has(node.id)) {
                    console.log("ğŸ”” ä¸ºèŠ‚ç‚¹ " + node.id + " æ³¨å†Œå€¼åŒæ­¥ç›‘å¬å™¨");

                    // åˆå§‹åŒæ­¥å€¼
                    inputText1Widget.value = inputTextWidget.value;

                    // åˆ·æ–° input_text1 æ˜¾ç¤º
                    if (inputText1Widget.onChange) {
                        inputText1Widget.onChange();
                    }

                    // å­˜å‚¨åŸå§‹å›è°ƒï¼ˆå¦‚æœæœ‰ï¼‰
                    const originalCallback = inputTextWidget.callback;

                    // åˆ›å»ºæ–°çš„å›è°ƒå‡½æ•°ï¼ˆä½¿ç”¨é˜²æŠ–æ¨¡æ‹Ÿå¤±å»ç„¦ç‚¹äº‹ä»¶ï¼‰
                    let debounceTimer;
                    inputTextWidget.callback = (value, widget, node) => {
                        console.log("ğŸ”„ input_text å€¼å˜æ›´: " + value);

                        // æ‰§è¡ŒåŸå§‹å›è°ƒï¼ˆå¦‚æœæœ‰ï¼‰
                        if (originalCallback) {
                            originalCallback(value, widget, node);
                        }

                        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                        if (debounceTimer) clearTimeout(debounceTimer);

                        // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼ˆæ¨¡æ‹Ÿå¤±å»ç„¦ç‚¹ï¼‰
                        debounceTimer = setTimeout(() => {
                            console.log("ğŸ’« è§¦å‘åŒæ­¥ï¼ˆæ¨¡æ‹Ÿå¤±å»ç„¦ç‚¹ï¼‰");

                            // åŒæ­¥åˆ° input_text1
                            inputText1Widget.value = value;

                            // åˆ·æ–° input_text1 æ˜¾ç¤º
                            if (inputText1Widget.onChange) {
                                inputText1Widget.onChange();
                            }

                            // æ ‡è®°èŠ‚ç‚¹éœ€è¦åˆ·æ–°
                             try {
                                app.canvas.setDirty(true);
                                } catch (e) {
                                console.warn("åˆ·æ–°ç”»å¸ƒå¤±è´¥:", e);
                                }
                        }, 300); // 300msåè§¦å‘ï¼Œæ¨¡æ‹Ÿç”¨æˆ·åœæ­¢è¾“å…¥
                    };

                    // æ ‡è®°èŠ‚ç‚¹å·²æ³¨å†Œç›‘å¬å™¨
                    registeredNodes.add(node.id);
                }
            });
        };

        // åˆå§‹è®¾ç½®
        setTimeout(checkAndSetupNodes, 500);

        // ç›‘å¬èŠ‚ç‚¹æ·»åŠ äº‹ä»¶
        app.graph.onNodeAdded = function(node) {
            checkAndSetupNodes();
        };

        // ç›‘å¬èŠ‚ç‚¹ç§»é™¤äº‹ä»¶ï¼Œæ¸…ç†æ³¨å†Œè®°å½•
        app.graph.onNodeRemoved = function(node) {
            registeredNodes.delete(node.id);
        };
    },
});
